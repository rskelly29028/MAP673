<!DOCTYPE html>
<html>

<head>
    <meta charset=utf-8 />
    <title>Lab 01 Template</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />
    <link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
    
    <script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-statistics/1.0.1/simple_statistics.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: whitesmoke;
            font-family: Lato, sans-serif;
            color: #0D0000;
        }
        header {
            width: 80%;
            margin: 10px auto 10px auto;
            background: blue;
        }
        h1 {
            display: inline-block;
            margin-right: 20px;
            color: #001323;
        }
        h2 {
            display: inline-block;
            color: whitesmoke;
        }
        #map {
            width: 80%;
            height: 540px;
            margin: 10px auto 10px auto;
            background: whitesmoke;
            border: 2px solid #dddedf;
            background: gray;
        }
        footer {
            width: 80%;
            margin: 10px auto 10px auto;
            background: black;
        }
        p {
            font-size: 1em;
            color: white;
        }
        .legend {
            padding: 6px 8px;
            font-size: 1em;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            }
        .legend h3 {
                font-size: 1.1em;
                font-weight: bold;
                color: #001323;
                margin: 0 0 10px 0;
            }
        .legend span {
                width: 20px;
                height: 20px;
                float: left;
                margin: 0 10px 4px 0;
            }
        .legend label {
                font-size: 1.1em;
            }
        .legend label:after {
                content: '';
                display: block;
                clear: both;
            }
        
    </style>
</head>

<body>
    <header>
        <h1>Housing Rental in Kentucky</h1>
        <h2><i>Percent Renter Occupied by County</i></h2>
    </header>

    <div id='map'></div>

    <footer>
        <p><i>Map authored by Ryan Kelly</i></p>
        <p><i>Map created on October 13, 2016</i></p>
        <p><i>GeoJSON Data courtesy of American Fact Finder, 2010 Census, SF1 </i></p>
        <p><i>The purpose of the map is to display the percent of the total poplation residing in rental properties.  Rental rates tend to be significantly higher in urban counties (such as Fayette and Jefferson) where there are greater numbers of people occupying apartment complexes.  There is also a higher-than-average number of rental properties in counties which are home to a major university and/or a military base, underscoring the highly transient nature of college students and military personnel.  The symbology can influence the nature of the data by placing it in natural breaks, thus maximizing the range of rental residents per county.  Had the author elected to classify by quantiles and/or by standard deviations from the mean, the display would be markedly different.  The map also does not show the actual raw number of renters per county, thus slight increases or decreases in the number of renters in a sparsely populated county can radically alter its display.</i>
        </p>
    </footer>

    <script>
        
    var options = {
    center: [37.8, -85.8],
    zoom: 7.4,
    zoomControl: false
}

    var attribute = "RENTER";
    var norm = "TOTAL";
    var name = "NAME";
    var map = L.map('map', options);    
    
    map.addControl(L.control.zoom({position: 'topright'}));    
    $.getJSON("ky_counties_housing.json", function(data) {
        var dataLayer = L.geoJson(data,{
            style: function(feature) {
                return {
                    color: 'white',
                    weight: 1,
                    fillOpacity: 1,
                    fillColor: '#1f78b4'
                }
        }  
        
    }).addTo(map);
        
    console.log(data);  
    
    drawMap(dataLayer);
        
       map.on('click', function(e){
            var newlatlng = e.latlng;
            console.log(newlatlng);
            map.setView(newlatlng,8);
            dataLayer.eachLayer(function(layer){
                var attribute = layer.feature.properties.RENTER;
                var norm = layer.feature.properties.TOTAL;
                var name = layer.feature.properties.NAME;
                var renter = Math.round((attribute/norm)*100);
                layer.bindPopup(renter + "%" + " are renters in " + name + " County");
       })
    })
    });  
        
    function drawMap(dataLayer){
        
        var breaks = getClassBreaks(dataLayer);
        
        dataLayer.eachLayer(function(layer) {
            layer.setStyle({
                fillColor : getColor(layer.feature.properties[attribute]/layer.feature.properties[norm],breaks)
            })
        });
       
        drawLegend(breaks);
    }
    
    function getClassBreaks(dataLayer){
        
        var values = [];
        
        dataLayer.eachLayer(function(layer) {
            values.push(layer.feature.properties[attribute]/layer.feature.properties[norm])
            
    }); 
        console.log(values);
        var clusters = ss.ckmeans(values, 5);  
        var breaks = clusters.map(function(cluster){
            return [cluster[0],cluster.pop()];   
    });
        console.log(breaks);
        return breaks;         
    }
        
    function getColor(d, breaks){
    
      if(d <= breaks[0][1]) {
            return '#f1eef6';
        } else if(d <= breaks[1][1]) {
            return '#bdc9e1';
        } else if(d <= breaks[2][1]) {
            return '#74a9cf';
        } else if(d <= breaks[3][1]) {
            return '#2b8cbe'
        } else if(d <= breaks[4][1]) {
            return '#045a8d'
        }
    }
         
    function drawLegend(breaks){

        var legend = L.control({position: 'topleft'});
        
        legend.onAdd = function(){
            var div = L.DomUtil.create('div', 'legend');
            div.innerHTML = "<h3>" + "<b><u>PERCENT RENTER OCCUPIED</u></b>"  + "</h3>";
            for (var i = 0; i < breaks.length; i++) {
                var color = getColor(breaks[i][0], breaks);
                div.innerHTML +=
                   '<span style="background:' + color + '"></span> ' +
                   '<label>'+(breaks[i][0]*100).toLocaleString()+'%' + ' &mdash; ' + 
                    (breaks[i][1]*100).toLocaleString()+'%' + '</label>';
            }
            return div;
        };
        
        legend.addTo(map);
    }
                
    </script>
    
</body>

</html>