<!DOCTYPE html>
<html>

<head>
    <meta charset=utf-8 />
    <title>MAP 673 Final Project</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" />
    <link href='https://fonts.googleapis.com/css?family=Work+Sans:400,500,600' rel='stylesheet' type='text/css'>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: whitesmoke;
            font-family: "Work Sans", sans-serif;
        }

        #side-panel {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 32%;
            background: navy;
            border-right: 2px solid navy;
            overflow-y: scroll;
        }

        h1 {
            padding: 8px 25px 8px 15px;
            margin: 0;
            background: red;
            color: white;
            font-weight: 500;
            font-size: 2.5em;
            text-align: center;
        }

        h2 {
            margin: 0;
            padding: 8px 25px 8px 15px;
            color: white;
            font-weight: 500;
            font-size: 1.2em;
            text-align: center;
        }

        #side-panel p {
            margin: 8px 0 4px;
            padding: 0 25px 0 15px;
            color: white;
            text-align: center;
            font-size: 1em;
        }

        #side-panel p:after {
            content: '';
            display: block;
            clear: both;
        }

        #side-panel img {
            float: center;
            margin: 0 0 15px 15px;
            border: 1px solid white;
        }

        #map {
            position: absolute;
            order: bottom;
            top: 0;
            bottom: 0;
            right: 0;
            width: 68%;
        }

        .info {
            color: white;
            padding: 6px 8px;
            font-size: 1em;
            background: black;
            border-width: medium;
            border-color: white;
            text-align: left;
        }

        .info h3 {
            color: white;
            text-align: left;
            margin: 0;
        }

        .legend {
            padding: 6px 8px;
            font-size: 1em;
            color: white;
            background: black;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            border-width: thin;
            border-color: white;
        }

        .legend h3 {
            font-size: 1.1em;
            font-weight: normal;
            color: #ffffff;
            margin: 10 0 10px 0;
        }

        .legend span {
            width: 20px;
            height: 20px;
            float: left;
            margin: 0 10px 4px 0;
        }

        .legend label {
            font-size: 1.1em;
            content: '';
            display: block;
            clear: both;
        }

        #voting {
            color: white;
            background-color: darkslategray;
        }

        #ui-controls {
            position: absolute;
            margin-left: 33%;
            margin-top: -3%;
            background-color: black;
            z-index: 800;
        }

        #ui-controls label {
            font-size: 1em;
            color: white;
            margin-right: 5px;
        }

    </style>
</head>

<body>
    <div id='map'></div>
    <div id='side-panel'>
        <h1>THE CHOICE</h1>
        <h2>The 2016 US Presidential Election</h2>
        <p>This map displays voting data by county for the 2016 general election, as well as select demographic, income and education data by county.</p>
        <p><img src="graphics/donald-trump-hillary-clinton-impossible-choice.png" alt="legend"></p>
        <p>306.....................Electoral Votes.................232</p>
        <p><img src="graphics/red-blue.png" alt="legend"></p>
        <p>The 58th quadrennial Presidetial Election, held on November 8, 2016, saw GOP candidate Donald Trump score a stunning upset over Democratic nominee Hillary Clinton to become the 45th President of the United States of America. This was the fourth election in U.S. history - and the second of the 21st century - to see the candidate who won the Electoral College lose the popular vote. The 2016 election further saw the polarization in American political preferences with the Democratic nominee winning by wide margins in heavily urban counties and the GOP nominee winning by huge margins in rural counties. Demographic data clearly indicate well-defined voting patterns that follow both racial and educational lines, with Clinton faring well among minority populations and those holding college degrees, and with Trump winning counties by large margins where the majority of the population was white and did not hold college degrees.</p>
        <p>State data is limited to vote totals, with states won by Hillary Clinton featured in blue and states won by Donald Trump featured in red. Scroll the mouse over the state map to view the number of votes won by each candidate in each state, along with the number of electoral votes awarded to the winner.  The user is encouraged to browse the map data by selecting counties from the tab at upper right and then selecting from the attributes listed in the dropdown menu in the upper left corner of the map. The selected data of each county will populate the information box at the right of the screen as the user scrolls the mouse over the selected county.</p>
        <h2><u>About This Map</u></h2>
        <p><i>Map created December 10, 2016, by Ryan Kelly, Professor of Geography, GISP, Bluegrass Community and Technical College</i></p>
        <h2><u>About the Data</u></h2>
        <p><i>The data were furnished from the 2010 US Census (http://www.census.gov/2010census/) and David Leip's Presidential Atlas 2016 (http://uselectionatlas.org).  County level voting data unavailable for Alaska</i></p>
    </div>
    <div id="info">
        <h3><u>County Information</u></h3>

    </div>

    <div id='ui-controls'>
        <select id="voting">
            <option value="VOTE">Voting Data 2016 General Election</option>
            <option value="MINORITY">% Minority (2010 US Census)</option>
            <option value="BLACK">% African-American (2010 US Census)</option>
            <option value="LATINO">% Latino (2010 Census)</option>
            <option value="INCOME">Income Data (2010 US Census)</option>
            <option value="EDUCATION">Education Data (2010 US Census)</option>
        </select>
    </div>

    <script src='https://cdnjs.cloudflare.com/ajax/libs/simple-statistics/1.0.1/simple_statistics.min.js'></script>
    <script src="http://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
    <script>

        var map = L.map('map', {
            center: [38, -97.5],
            zoom: 4,
            minZoom: 2,
            maxZoom: 12,
            maxBounds: L.latLngBounds([75, -170], [10, -30]),
         });

        var CartoDB_DarkMatter =
            L.tileLayer('http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
            subdomains: 'abcd',
            maxZoom: 19

            }).addTo(map);

        map.zoomControl.setPosition('topright');

        var countyLayer, statesLayer, lakesLayer, dataLayer;
        //var attribute = "VOTE";

        var labels = {
            "VOTE CLINTON": "Votes for Hillary Clinton",
            "VOTE TRUMP": "Votes for Donald Trump"
        }

        // Load the map data using queue

        queue()
            .defer(d3.json, "US-Counties.json")
            .defer(d3.json, "us-states.json")
            .defer(d3.csv, "Election-States.csv")
            .defer(d3.csv, "Master.csv")
            .defer(d3.json, "Great-Lakes.json").await(processData);

        // create a function to loop through the counties data and grab the county FIPS code to ensure a match for each county
        function processData(e, counties, states, statesData, countiesData, lakes) {

            for (var state in states.features) {

                var stateFIP = states.features[state].properties.STATEFP;

                for (var d in statesData) {
                    if (stateFIP === statesData[d].state_fp) {
                        states.features[state].properties = statesData[d];
                        break;
                    }
                }
            }

            for (var county in counties.features) {

                var countyFIP = counties.features[county].properties.GEOID;

                for (var d in countiesData) {
                    var countiesDataFip = countiesData[d].fips;
                    // need to slice off last five characters for FIPS code
                    countiesDataFip = countiesDataFip.slice(-5, countiesDataFip.length);
                    if (countyFIP === countiesDataFip) {
                        counties.features[county].properties = countiesData[d];
                        break;
                    }
                }
            }

            drawLegend();
            drawMap(states, counties, lakes);
            buildUI();
            drawInfo();


        }

        function drawMap(states, counties, lakes) {

            var value = $('#voting').val(); //value will be set VOTE for the initial load

            countiesLayer = L.geoJson(counties, {

                // onEachFeature: onEachFeature,

                    style: function (feature) { // style each feature of GeoJson layer
                        return {
                        color: 'white', // set stroke color
                        fillColor: getCountyColor(feature, value),
                        weight: 0.5, // set stroke weight
                        fillOpacity: 1, // override defautl fill opacity
                    };
                },


                onEachFeature: function (feature, layer) {

                    layer.on('click', function(){

                        updateInfo(this);
                        updateLegend(feature);
                        //onEachFeature();
                    });

                    layer.on('mouseover', function(e) {

                        layer.setStyle({
                            weight: 2.5,
                            color: 'yellow'
                        });
                    });

                    layer.on('mouseout', function(e){

                        layer.setStyle({
                            weight: 0.5,
                            color: 'white',
                        });
                    });
                }
            }).addTo(map);

                statesLayer = L.geoJson(states, {
                    // onEachFeature: onEachFeature,
                        style: function (feature) { // style each feature of GeoJson layer
                            return {
                            color: 'white', // set stroke color
                            fillColor: getStateColor(feature),
                            weight: 1.5, // set stroke weight
                            fillOpacity: 1, // override defautl fill opacity
                    };
                },
                    onEachFeature: function (feature, layer) {

                    var tooltip = '<b>STATE:</b> ' + feature.properties.name  + '<br>' +
                                  '<b>Clinton:</b> ' + feature.properties.clinton + '<br>' +
                                  '<b>Trump:</b> ' + feature.properties.trump + '<br>' +
                                  '<b>Electoral Votes:</b> ' + feature.properties.votes + '<br>' +
                                  '<b>WINNER:</b> ' + feature.properties.winner + '<br>' +
                                  getStatePicture(feature);

                    layer.bindTooltip(tooltip, {
                        sticky: true,
                    });

                }

            });

            lakesLayer = L.geoJson(lakes, {
                style: function (feature) { // style each feature of GeoJson layer
                    return {
                        color: 'white', // set stroke color
                        fillColor: 'navy',
                        weight: 0.5, // set stroke weight
                        fillOpacity: 1, // override defautl fill opacity
                    };
                }

            });

            var sourcesLayers = {
                "States": statesLayer,
                "Counties": countiesLayer,

            }

            L.control.layers(null, sourcesLayers, {
                collapsed: false

            }).addTo(map);

        }


        function getStateColor(feature) {
            var clinton = Number(feature.properties.clinton);
            var trump = Number(feature.properties.trump);
            if (clinton > trump) {
                return "#0101df";
            }
            else if (trump > clinton) {
                return "#fe2e2e";
            }
        }

        function getStatePicture (feature) {
            var clinton = Number(feature.properties.clinton);
            var trump = Number(feature.properties.trump);
            if (clinton > trump) {
                return "<img src='./graphics/Hillary_Clinton.jpg' />";
            }
            else if (trump > clinton) {
                return "<img src='./graphics/Donald_Trump.jpg' />";
            }
        }

        function getCountyColor(feature, value) {

            var clinton = Number(feature.properties.clinton);
            var trump = Number(feature.properties.trump);
            var johnson = Number(feature.properties.johnson);
            var stein = Number(feature.properties.stein);
            var mcmullin = Number(feature.properties.mcmullin);
            var totalvote = Number(feature.properties.totalvote);
            var medianHI = Number(feature.properties.Median_HI);
            var bachelor = Number(feature.properties.bachelor);
            var masters = Number(feature.properties.master_Phd);
            var total_pop = Number(feature.properties.pop_Total);
            var black = Number(feature.properties.pop_Black);
            var latino = Number(feature.properties.pop_Latino);
            var asian = Number(feature.properties.pop_Asian);
            var native = Number(feature.properties.pop_Amrind);

            if (value == "VOTE"){
                    return getCountyVoteColor(feature)
            }   else if (value == "BLACK"){
                    return  getCountyBlackColor(feature)
            }   else if (value == "LATINO"){
                    return getCountyLatinoColor(feature)
            }   else if (value == "MINORITY"){
                    return getCountyMinorityColor(feature)
            }   else if (value == "INCOME"){
                    return getCountyIncomeColor(feature)
            }   else if (value == "EDUCATION"){
                    return getCountyEducationColor(feature)
            }

                }

        function getCountyVoteColor(feature) {
            var clinton = Number(feature.properties.clinton);
            var trump = Number(feature.properties.trump);
            var johnson = Number(feature.properties.johnson);
            var stein = Number(feature.properties.stein);
            var mcmullin = Number(feature.properties.mcmullin);
            var totalvote = Number(feature.properties.totalvote);

            if (clinton / (totalvote - johnson - stein - mcmullin) >= 0.6) {
                return "#08088A";
            }
            else if (clinton / (totalvote - johnson - stein - mcmullin) >= 0.55) {
                return "#0101df";
            }
            else if (clinton / (totalvote - johnson - stein - mcmullin) >= 0.5) {
                return "#81BEF7";
            }
            else if (clinton / (totalvote - johnson - stein - mcmullin) >= 0.45) {
                return "#f5a9a9";
            }
            else if (clinton / (totalvote - johnson - stein - mcmullin) >= 0.40) {
                return "#fe2e2e";
            }
            else if (clinton / (totalvote - johnson - stein - mcmullin) >= 0.01) {
                return "#df0101"
            }
        }

        function getCountyIncomeColor(feature) {
            var medianHI = Number(feature.properties.Median_HI);

            if (medianHI >= 70000) {
                return "#004d00";
            }
            else if (medianHI>= 50000) {
                return "#009900";
            }
            else if (medianHI >= 40000) {
                return "#00e600";
            }
            else if (medianHI >= 30000) {
                return "#99ff99";
            }
            else  {
                return "#c2f0c2";
            }
        }

        function getCountyEducationColor(feature) {
            var bachelor = Number(feature.properties.bachelor);
            var masters = Number(feature.properties.master_Phd);
            var total_pop = Number(feature.properties.pop_Total);

            if ((bachelor+masters)/total_pop >= 0.35) {
                return "#29293d";
            }
            else if ((bachelor+masters)/total_pop >= 0.25) {
                return "#666699";
            }
            else if ((bachelor+masters)/total_pop >= 0.15)  {
                return "#a3a3c2";
            }
            else if ((bachelor+masters)/total_pop >= 0.05) {
                return "#c2c2d6";
            }
            else  {
                return "#e0e0eb";
            }
        }

        function getCountyBlackColor(feature) {
            var black = Number(feature.properties.pop_Black);
            var total_pop = Number(feature.properties.pop_Total);

            if (black/total_pop >= 0.75) {
                return "#663300";
            }
            else if (black/total_pop >= 0.50) {
                return "#b35900";
            }
            else if (black/total_pop >= 0.1)  {
                return "#ff8000";
            }
            else if (black/total_pop >= 0.01) {
                return "#ffb366";
            }
            else  {
                return "#ffd9b3";
            }
        }

        function getCountyLatinoColor(feature) {
            var latino = Number(feature.properties.pop_Latino);
            var total_pop = Number(feature.properties.pop_Total);

            if (latino/total_pop >= 0.75) {
                return "#662900";
            }
            else if (latino/total_pop >= 0.50) {
                return "#ff6600";
            }
            else if (latino/total_pop >= 0.1)  {
                return "#ff944d";
            }
            else if (latino/total_pop >= 0.01) {
                return "#ffb380";
            }
            else  {
                return "#ffe0cc";
            }
        }

        function getCountyMinorityColor(feature) {
            var black = Number(feature.properties.pop_Black);
            var latino = Number(feature.properties.pop_Latino);
            var asian = Number(feature.properties.pop_Asian);
            var native = Number(feature.properties.pop_Amrind);
            var total_pop = Number(feature.properties.pop_Total);

            if ((black + latino + asian + native)/total_pop >= 0.8) {
                return "#66004d";
            }
            else if ((black + latino + asian + native)/total_pop >= 0.50) {
                return "#cc0099";
            }
            else if ((black + latino + asian + native)/total_pop >= 0.1)  {
                return "#ff33cc";
            }
            else if ((black + latino + asian + native)/total_pop >= 0.05) {
                return "#ff80df";
            }
            else  {
                return "#ffccf2";
            }
        }

        // create function to update the map
        function updateMap(){

                countiesLayer.eachLayer(function(layer){

                layer.setStyle({
                    fillColor: getCountyColor(layer.feature, attribute)
            });
        })

        }

        function drawLegend() {

			// create a new Leaflet control object, and position it top left
			var legend = L.control({
				position: 'bottomleft'
			});

			// when the legend is added to the map
			legend.onAdd = function (map) {

				// create a new HTML <div> element and give it a class name of "legend"
				var div = L.DomUtil.create('div', 'legend');

				return div;

			};

			// add the legend to the map
			legend.addTo(map);
		}

        function updateLegend(feature) {

            // creates natural breaks and assigns colors to different classes

            //var props = layer.feature.properties;

            var legend = $('.legend').html("<h3>" + "LEGEND" + "</h3><ul>");

                    var color = getCountyVoteColor(feature);

                legend.append(
                    '<span style="background:' + color + '"></span> ' + '<label>' +"Clinton >60%"+ feature.properties.clinton/feature.properties.total_vote + '&mdash;'  + '</label>' +
                    '<span style="background:' + color + '"></span> ' + '<label>' +"Clinton 55%-60%"+ feature.properties.clinton + '&mdash;'  + '</label>' +
                    '<label>'+ feature.clinton + '&mdash;'  + '</label>' +
                    '<label>'+ feature.clinton + '&mdash;'  + '</label>');


        }

        function buildUI() {
            $('select[id="voting"]').change(function () {
                attribute = $(this).val();

                updateMap();
            });
        }


          function drawInfo(layer, feature) {
          // creates an information box in the lower right corner of map frame

                var info = L.control({position: 'bottomright'});

                info.onAdd = function(map) {

                var div = L.DomUtil.create('div', 'info');

                return div;

            }

            info.addTo(map);
            // adds data to information box upon mouseover event
            countiesLayer.on('mouseover', function() {
                $(".info").show();
            });
            // removes data from information box upon mouseout event
            countiesLayer.on('mouseout', function() {
                $(".info").hide();
            });

        }

          function updateInfo(layer){

                var props = layer.feature.properties;

                var html = "<h3>" + props.name +" County</h3>" +
                           "State: <b>"+ props.state+"</b><br>" +
                           "Population: <b>"+ props.pop_Total+"</b><br>" +
                           "% Vote for Clinton: <b>"+ ((props.clinton/props.totalvote)*100).toFixed(2)+"%</b><br>" +
                           "% Vote for Trump: <b>"+ ((props.trump/props.totalvote)*100).toFixed(2) +"%</b><br>" +
                           "% White: <b>"+ ((props.pop_White/props.pop_Total)*100).toFixed(2)+"%</b><br>" +
                           "% African-American: <b>"+ ((props.pop_Black/props.pop_Total)*100).toFixed(2)  +"%</b><br>" +
                           "% Latino: <b>"+ ((props.pop_Latino/props.pop_Total)*100).toFixed(2)+"%</b><br>" +
                           "% Asian: <b>"+  ((props.pop_Asian/props.pop_Total)*100).toFixed(2)+"%</b><br>" +
                           "% Native American: <b>"+ ((props.pop_Amrind/props.pop_Total)*100).toFixed(2)+"%</b><br>" +
                           "% Male: <b>"+  ((props.pop_Males/props.pop_Total)*100).toFixed(2)+"%</b><br>" +
                           "% Female: <b>"+ ((props.pop_Females/props.pop_Total)*100).toFixed(2)+"%</b><br>" +
                           "Per Capita Income: <b>$"+ props.Income+"</b><br>" +
                           "Median Household Income: <b>$"+ props.Median_HI+"</b><br>" +
                           "% Under 18 Living in Poverty: <b>"+ ((props.Under18_POV/props.pop_Total)*100).toFixed(2)+"%</b><br>" +
                           "% with Bachelor Degree: <b>"+ ((props.bachelor/props.pop_Total)*100).toFixed(2)+"%</b><br>" +
                           "% with Masters or PhD: <b>"+ ((props.master_Phd/props.pop_Total)*100).toFixed(2)+"%</b><br>"

               $(".info").html(html);
          }


    </script>
</body>

</html>
