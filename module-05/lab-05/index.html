<!DOCTYPE html>
<html>

<head>
    <meta charset=utf-8 />
    <title>MAP 673 Lesson 05</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />
    <link href='https://fonts.googleapis.com/css?family=Work+Sans:400,500,600' rel='stylesheet' type='text/css'>

    <style>

      body {
            margin: 0;
            padding: 0;
            background: whitesmoke;
            font-family: "Work Sans", sans-serif;
        }

        #side-panel {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 33%;
            background: navy;
            border-right: 2px solid navy;
            overflow-y: scroll;
        }

        h1 {
            padding: 8px 25px 8px 15px;
            margin: 0;
            background: red;
            color: whitesmoke;
            font-weight: 400;
            font-size: 1.5em;
            text-align: center;
        }

        h2 {
            margin: 0;
            padding: 8px 25px 8px 15px;
            color: white;
            font-weight: 500;
            font-size: 1.2em;
            text-align: left;
        }

        #side-panel p {
            margin: 8px 0 4px;
            padding: 0 25px 0 15px;
            color: white;
            text-align: left;
            font-size: 1em;
        }

        #side-panel p:after {
            content: '';
            display: block;
            clear: both;
        }

        #side-panel img {
            float: center;
            margin: 0 0 15px 15px;
            border: 1px solid white;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            width: 67%;
        }

        #legend {
            position: absolute;
            background: whitesmoke;
            right: 15px;
            padding: 8px 15px;
            bottom: 20px;
            width: 160px;
            color: black;
            border: 1px solid black;
            border-radius: 3px;
            text-align: center
        }

        #legend h3 {
            text-align: center;
            font-weight: 500;
            margin: 10px 0 20px;
        }

        #side-panel {}

        #info {
            padding: 8px 15px;
            position: absolute;
            color: black max-width: 200px;
            font-size: 1em;
            background: whitesmoke;
            border: 2px solid #000000;
            border-radius: 3px;
        }

        #info p {
            margin: 3px 0 4px;
        }

        .females {
            font color: red;
        }

        .males {
            font color: blue;
        }
        
    </style>

</head>

<body>
    <div id='map'></div>
    <div id='side-panel'>
        <h1>Gender Distribution in Kenya</h1>
        <h2>2009 Census Data for Males and Females</h2>
        <p><i>This map displays the number of males and females by county in Kenya in 2009.  Blue circles represent males, red circles represent females.</i></p>
        <p><img src="lab-05-graphics/Flag_of_Kenya.svg.png" alt="legend"></p>
        <p><i>Kenya, like the majority of nations around the world, has more females in its general population than it does males. Several counties in Kenya contradict the general sex ratio found across the nation. There are more males than females in the rural frontier counties bordering both Sudan and Somalia. This can be attributed to the fact that these poor rural regions of Kenya tend to be dominated by both the energy industry as well as being overrepresented by military personnel protecting the porous frontiers of the nation from the political turmoil of Sudan and the threat of Islamic militants from Somalia.  The urban areas of Kenya, in particular the capital of Nairobi, contain significantly more males as men are more apt to migrate to urban areas to find work in construction and/or other urban service occupations, leaving women behind to tend to family and agricultural responsibilities in rural regions, most notably in the western Lake District adjacent to Lake Victoria and the Tanzanian border.</i></p>
        <h2><u>About This Map</u></h2>
        <p><i>This map was created Friday, November 11, 2016 by Ryan Kelly</i></p>
        <h2><u>About the Data</u></h2>
        <p><i>The data were furnished from the Kenyan Open Data Portal located at the following URL:  https://opendata.go.ke/</i></p>
    </div>

    <div id="legend">
        <h3>Males and Females Per County in Kenya</h3>
        <p><i>Blue Circles Correspond to Males, Red Circles to Females</i></p>
        <svg class="legend" width="200" height="200"></svg>
    </div>

    <div id="info">
        <p>County: <span> </span></p>
        <p>Males:
            <span1> </span1>
        </p>
        <p>Females:
            <span2> </span2>
        </p>
    </div>

    <script src='https://cdnjs.cloudflare.com/ajax/libs/simple-statistics/1.0.1/simple_statistics.min.js'></script>
    <script src="http://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
    <script>
        L.mapbox.accessToken = 'pk.eyJ1Ijoicmdkb25vaHVlIiwiYSI6Im5Ua3F4UzgifQ.PClcVzU5OUj17kuxqsY_Dg';

        var map = L.mapbox.map('map', 'mapbox.streets', {
            center: [-.23, 37.8],
            zoom: 6,
            minZoom: 5,
            maxZoom: 10,
            maxBounds: L.latLngBounds([-6.22, 27.72], [5.76, 47.83])
        });

        var dataLayer;

        $.getJSON("kenyan-counties.geojson", function(data) {
            console.log(data);
            dataLayer = L.geoJson(data, {
                onEachFeature: onEachFeature,
                style: function (feature) { // style each feature of GeoJson layer
				    return {
				        color: 'gray', // set stroke color
				        weight: 0.5, // set stroke weight
				        fillOpacity: 0, // override defautl fill opacity
					   };
				    }
        
            }).addTo(map); // add the Leaflet GeoJson layer to the map
        
        omnivore.csv('Kenya_Population.csv')
            .on('ready', function(e) {
                drawMap(e.target.toGeoJSON())
        })
            .on('error', function(e) {
                console.log(e.error[0].message);
        });
            
        });
        
        var scaleFactor = 0.6;

        // create the main function to draw blue and red circles for males and females
        function drawMap(popData) {
            var females = L.geoJson(popData, {
                pointToLayer: function(feature, layer) {
                    return L.circleMarker(layer, {
                        color: 'red',
                        opacity: 1,
                        weight: 4,
                        fillOpacity: 0,
                    });
                }

            }).addTo(map);

            var males = L.geoJson(popData, {
                pointToLayer: function(feature, layer) {
                    return L.circleMarker(layer, {
                        color: 'blue',
                        opacity: 1,
                        weight: 2,
                        fillOpacity: 0,

                });
            },
                
                onEachFeature: function(feature, layer) {
                    layer.on('mouseover', function(e) {

                        dataLayer.eachLayer(function(l) {
                            if (layer.feature.properties.County == l.feature.properties.COUNTY) {
                                l.setStyle({
                                    weight: 6,
                                    color: 'yellow',
                                    fillColor: 'green',
                                    fillOpacity: 0.5,
                                });
                            }
                        })
                    });

                    layer.on('mouseout', function(e) {

                        dataLayer.setStyle({
                          weight: 0.5,
                          color: 'gray',
                          fillOpacity: 0,
                        })
                    });
                }
                
            }).addTo(map);
              
        createSymbols(males,females);
        infoWindow(males,females);
        drawLegend();
       
                    };

        // build the function to calculate radii
        function calcRadius(val) {
            var radius = Math.sqrt(val / Math.PI);
            return radius * .075;
        }

        // create the function to create symbology based on CSV data
        function createSymbols(males, females) {
            var radius,
                allRadii = [];
            males.eachLayer(function(layer) {
                radius = (calcRadius(Number(layer.feature.properties.Male)));
                layer.setRadius(radius);
                allRadii.push(radius);
            });
            females.eachLayer(function(layer) {
                radius = (calcRadius(Number(layer.feature.properties.Female)));
                layer.setRadius(radius);
                allRadii.push(radius);
            });

        }

        // create the function to build the information window
        function infoWindow(males, females) {

            var info = $('#info');

            males.on('mouseover', function(e) {
                var props = e.layer.feature.properties;
                info.show();
                $('#info span').text(props.County);
                $('#info span1').text(props.Male);
                $('#info span2').text(props.Female);

                e.layer.setStyle({
 
                    fillOpacity: 0.6 
                });
                
        });
 
            males.on('mouseout', function(e) {
                info.hide();
                e.layer.setStyle({
                    fillOpacity: 0 });
                });
            
            $(document).mousemove(function(e) {
                // first offset from the mouse position of the info window
                info.css({
                    "left": e.pageX + 6,
                    "top": e.pageY - info.height() - 15
                });
 
                // if it crashes into the top, flip it lower right
                if (info.offset().top < 4) {
                    info.css({
                        "top": e.pageY + 15
                    });
                }
                // do the same for crashing into the right
                if (info.offset().left + info.width() >= $(document).width() - 40) {
                    info.css({
                        "left": e.pageX - info.width() - 30
                    });
                }
 
            });
        };

        
        function onEachFeature(feature, layer) {
            // changes color of layer to green with mouseover and returns back to original color settings with mouseout
 
            layer.on('mouseover', function(leafletEvent) {
 
                var dataLayer = leafletEvent.target;
                dataLayer.setStyle({
                    weight: 6,
                    color: 'yellow',
                    fillColor: 'green',
                    fillOpacity: 0.5,
 
            });
                
            layer.on('mouseout', function (leafletEvent){
                var dataLayer = leafletEvent.target;
                dataLayer.setStyle({
                    weight: 0.5,
                    color: 'gray',
                    fillOpacity: 0,
            });
            drawMap();
            
                })
 
            })
        }

        function drawLegend(allRadii) {
            var legend = $('.legend');

            var circles = {
                males: 65,
                females: 40
            }

            var mvgCircles = '';
            var fvgCircles = '';

            var reverseCalc = function(radius) {
                return Math.round((Math.pow(radius / scaleFactor, 2) * Math.PI));
            }

            for (var circle in circles) {

                mvgCircles += '<circle cx="' + 100 + '" cy="' + (circles[circle] - 180) * -1 + '" r="' + circles[circle] + '" stroke="blue" stroke-width="3" fill="whitesmoke"/>';

                mvgCircles += '<text x="' + 80 + '" y = "' + (circles[circle] - 160) * -1 + '" fill= "blue">' + reverseCalc(circles[circle]) + '</text>'
                
                fvgCircles += '<circle cx="' + 100 + '" cy="' + (circles[circle] - 180) * -1 + '" r="' + circles[circle] + '" stroke="red" stroke-width="3" fill="whitesmoke"/>';

                fvgCircles += '<text x="' + 80 + '" y = "' + (circles[circle] - 160) * -1 + '" fill= "red">' + reverseCalc(circles[circle]) + '</text>'
            }

            legend.html(mvgCircles, fvgCircles)

            }
        
    </script>
</body>

</html>
